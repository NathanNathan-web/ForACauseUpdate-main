{% extends "base.html" %}
{% block title %}- ForACause -  Admin Voucher{% endblock %}

{% block content %}
<div class="voucher-container">
    <div class="voucher-card">

        <!-- Expired Voucher Notifications -->
        {% if notifications %}
        <div class="alert alert-danger mb-4">
            <h5>Expired Voucher Notifications:</h5>
            <ul>
                {% for notification in notifications %}
                <li>{{ notification }}</li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}

        <!-- Search and Filter Section -->
        <div class="search-filter-container">
            <div class="search-bar mb-4">
                <input 
                    type="text" 
                    id="searchInput" 
                    class="form-control search-input" 
                    placeholder="Search vouchers..."
                    onkeyup="searchVouchers()"
                >
                <button id="searchButton" class="btn btn-primary search-btn" onclick="searchVouchers()">Search</button>
            </div>
            <div class="date-filter mb-4">
                <input 
                    type="text" 
                    id="startDate" 
                    class="form-control date-input" 
                    placeholder="Start Date"
                >
                <input 
                    type="text" 
                    id="endDate" 
                    class="form-control date-input" 
                    placeholder="End Date"
                >
                <button id="filterButton" class="btn btn-success filter-btn" onclick="filterByDate()">Filter</button>
            </div>
        </div>

        <!-- Voucher Table -->
        <div class="table-responsive">
            <table class="table table-hover" id="voucherTable">
                <thead>
                    <tr>
                        <th>Logo</th>
                        <th>Voucher ID</th>
                        <th>Name</th>
                        <th>Description</th>
                        <th>Value</th>
                        <th>Credit</th>
                        <th>Redeem Date</th>
                        <th>Expiry Date</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for voucher in voucher_list %}
                    <tr>
                        <td><img src="{{ url_for('static', filename='images/' + voucher.image_file) }}" alt="Logo" class="voucher-logo"></td>
                        <td>{{ voucher.id }}</td>
                        <td>{{ voucher.name }}</td>
                        <td>{{ voucher.description }}</td>
                        <td>${{ voucher.value }}</td>
                        <td>{{ voucher.credit }}</td>
                        <td>{{ voucher.redeem_date }}</td>
                        <td>{{ voucher.expiry_date }}</td>
                        <td>
                            {% if voucher.isValid %}
                            <a href="{{ url_for('vouchervalidity', id=voucher.id) }}">
                                <button class="btn btn-success status-btn">Valid</button>
                            </a>
                            {% else %}
                            <a href="{{ url_for('vouchervalidity', id=voucher.id) }}">
                                <button class="btn btn-danger status-btn">Non-valid</button>
                            </a>
                            {% endif %}
                        </td>
                        <td>
                            <a href="/updateVoucher/{{ voucher.id }}" class="btn btn-warning action-btn">
                                <i class="bi bi-pencil-square"></i>
                            </a>
                            <!-- Delete Button and Modal -->
                            <button type="button" class="btn btn-danger action-btn" data-bs-toggle="modal" data-bs-target="#deleteModal_{{ voucher.id }}">
                                <i class="bi bi-trash"></i>
                            </button>
                            <!-- Modal -->
                            <div class="modal fade" id="deleteModal_{{ voucher.id }}" tabindex="-1" aria-labelledby="modalLabel_{{ voucher.id }}" aria-hidden="true">
                                <div class="modal-dialog">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title" id="modalLabel_{{ voucher.id }}">Confirm Delete</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                        </div>
                                        <div class="modal-body">
                                            Are you sure you want to delete the voucher <strong>{{ voucher.name }}</strong>?
                                        </div>
                                        <div class="modal-footer">
                                            <form action="{{ url_for('deletevoucher', id=voucher.id) }}" method="POST">
                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                                <button type="submit" class="btn btn-danger">Delete</button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="add-voucher mt-4 text-center">
            <a href="/createVoucher">
                <button class="btn btn-outline-info add-btn">Add Voucher</button>
            </a>
        </div>
    </div>
</div>

<script>
    // Search Functionality
    function searchVouchers() {
        const input = document.getElementById('searchInput').value.toLowerCase();
        const rows = document.querySelectorAll('#voucherTable tbody tr');
        rows.forEach(row => {
            const text = row.innerText.toLowerCase();
            row.style.display = text.includes(input) ? '' : 'none';
        });
    }

    // Filter by Date Range
    function filterByDate() {
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        const rows = document.querySelectorAll('#voucherTable tbody tr');

        const start = startDate ? new Date(startDate) : null;
        const end = endDate ? new Date(endDate) : null;

        rows.forEach(row => {
            const redeemDateText = row.querySelectorAll('td')[6].innerText.trim();
            const redeemDate = new Date(redeemDateText);
            if (isNaN(redeemDate.getTime())) {
                row.style.display = 'none';
                return;
            }
            if (start && end) {
                row.style.display = (redeemDate >= start && redeemDate <= end) ? '' : 'none';
            } else if (start) {
                row.style.display = (redeemDate >= start) ? '' : 'none';
            } else if (end) {
                row.style.display = (redeemDate <= end) ? '' : 'none';
            } else {
                row.style.display = '';
            }
        });
    }

    // Initialize Flatpickr and Attach Event Listeners
    document.addEventListener('DOMContentLoaded', () => {
        flatpickr("#startDate", { dateFormat: "Y-m-d", onChange: filterByDate });
        flatpickr("#endDate", { dateFormat: "Y-m-d", onChange: filterByDate });
    });
</script>

<style>
.voucher-container {
    background: linear-gradient(135deg, #f6f9fc, #e9f0f7);
    min-height: 100vh;
    display: flex;
    justify-content: center;
    padding: 30px;
}

.voucher-card {
    background: white;
    border-radius: 20px;
    box-shadow: 0 12px 30px rgba(0, 0, 0, 0.1);
    width: 100%;
    max-width: 1200px;
    padding: 30px;
}

.table {
    border-radius: 10px;
    width: 100%;
    overflow: hidden;
}

.table th, .table td {
    text-align: center;
    padding: 10px;
    vertical-align: middle;
}

.voucher-logo {
    height: 50px;
    border-radius: 5px;
}

.add-btn {
    font-weight: bold;
    font-size: 1.1rem;
}

.status-btn {
    font-weight: bold;
    padding: 5px 10px;
}
</style>
{% endblock %}
