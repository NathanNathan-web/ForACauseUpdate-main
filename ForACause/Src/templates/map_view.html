{% extends "base.html" %}

{% block content %}
<div class="container-fluid px-4 py-5">
    <h1 class="display-5 fw-bold text-primary mb-3 text-center">Volunteer Opportunities Near Me</h1>

    <!-- Reset Button -->
    <button id="reset-btn" style="
        margin: 10px auto;
        display: block;
        padding: 12px 24px;
        background-color: #007BFF;
        color: #fff;
        border: none;
        border-radius: 50px;
        cursor: pointer;
        font-size: 16px;
        font-weight: bold;
        transition: background-color 0.3s, transform 0.3s;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        width: 200px;
        ">
        Reset View
    </button>

    <!-- Flex container for map and event list -->
    <div class="d-flex" style="gap: 20px; align-items: stretch;">
        <!-- Map Container -->
        <div id="map" style="height: 600px; flex: 0 0 67%;" class="shadow-sm mt-4 rounded"></div>

        <!-- Scrollable Event List -->
        <div class="col-lg-4">
            <div class="events-container rounded-4 shadow-sm h-100">
                <div class="events-header p-3 bg-light rounded-top-4 border-bottom">
                    <h4 class="mb-0"><i class="bi bi-calendar-event me-2"></i>Available Events</h4>
                </div>
                <div class="events-list p-3" style="max-height: 550px; overflow-y: auto;">
                    {% if events %}
                    <!-- Sort and render signed-up events first -->
                    {% for event in events if event.is_signed_up %}
                    <div class="event-card mb-3">
                        <div class="card border-0 shadow-sm">
                            <div class="card-body">
                                <h5 class="card-title text-primary mb-2">{{ event.name }}</h5>
                                <div class="event-details mb-3">
                                    <div class="detail-item">
                                        <i class="bi bi-calendar3 text-muted me-2"></i>
                                        <span>{{ event.date }}</span>
                                    </div>
                                    <div class="detail-item">
                                        <i class="bi bi-tag text-muted me-2"></i>
                                        <span>{{ event.category }}</span>
                                    </div>
                                    <div class="detail-item">
                                        <i class="bi bi-geo-alt text-muted me-2"></i>
                                        <span>{{ event.address }}</span>
                                    </div>
                                </div>

                                <!-- Status Indicator -->
                                <div class="d-flex justify-content-between align-items-center">
                                    {% set is_signed_up = event.id in signed_up_event_ids %}
                                    {% set is_completed = signed_up_event_ids.get(event.id, False) %}

                                    {% if is_signed_up %}
                                    {% if is_completed %}
                                    <span class="badge bg-success rounded-pill">
                                        <i class="bi bi-check-circle me-1"></i> Completed
                                    </span>

                                    <!-- Review Button (only shown when completed) -->
                                    <button class="btn btn-sm btn-outline-primary custom-button" data-bs-toggle="modal"
                                        data-bs-target="#reviewModal-{{ event.id }}">
                                        <i class="bi bi-star"></i> Review
                                    </button>
                                    {% else %}
                                    <span class="badge bg-warning rounded-pill">
                                        <i class="bi bi-clock me-1"></i> Signed Up
                                    </span>

                                    <!-- Directions Button (only shown when signed up but not completed) -->
                                    <a href="https://www.google.com/maps/dir/?api=1&origin=Your+Current+Location&destination={{ event.address | urlencode }}"
                                        target="_blank" class="btn btn-sm btn-outline-success custom-button">
                                        <i class="bi bi-map me-1"></i> Directions
                                    </a>
                                    {% endif %}
                                    {% else %}
                                    <a href="{{ url_for('confirm_volunteer', event_id=event.id) }}"
                                        class="btn btn-primary">
                                        <i class="bi bi-person-plus"></i> Sign Up
                                    </a>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Review Modal -->
                    <div class="modal fade" id="reviewModal-{{ event.id }}" tabindex="-1"
                        aria-labelledby="reviewModalLabel-{{ event.id }}" aria-hidden="true">
                        <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="reviewModalLabel-{{ event.id }}">Review {{ event.name }}
                                    </h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"
                                        aria-label="Close"></button>
                                </div>
                                <form method="POST" action="{{ url_for('submit_review', event_id=event.id) }}">
                                    <div class="modal-body">
                                        <div class="mb-3">
                                            <label for="rating-{{ event.id }}" class="form-label">Rating</label>
                                            <select name="rating" id="rating-{{ event.id }}" class="form-select"
                                                required>
                                                <option value="" disabled selected>Choose a rating</option>
                                                <option value="5">★★★★★</option>
                                                <option value="4">★★★★☆</option>
                                                <option value="3">★★★☆☆</option>
                                                <option value="2">★★☆☆☆</option>
                                                <option value="1">★☆☆☆☆</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label for="feedback-{{ event.id }}" class="form-label">Feedback</label>
                                            <textarea name="feedback" id="feedback-{{ event.id }}" rows="4"
                                                class="form-control" placeholder="Write your feedback..."
                                                required></textarea>
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="submit" class="btn btn-primary">Submit Review</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                    <!-- Render the rest of the events -->
                    {% for event in events if not event.is_signed_up %}
                    <div class="event-card mb-3">
                        <div class="card border-0 shadow-sm">
                            <div class="card-body">
                                <h5 class="card-title text-primary mb-2">{{ event.name }}</h5>
                                <div class="event-details mb-3">
                                    <div class="detail-item">
                                        <i class="bi bi-calendar3 text-muted me-2"></i>
                                        <span>{{ event.date }}</span>
                                    </div>
                                    <div class="detail-item">
                                        <i class="bi bi-tag text-muted me-2"></i>
                                        <span>{{ event.category }}</span>
                                    </div>
                                    <div class="detail-item">
                                        <i class="bi bi-geo-alt text-muted me-2"></i>
                                        <span>{{ event.address }}</span>
                                    </div>
                                </div>
                                <div class="d-flex justify-content-between align-items-center">
                                    <a href="/confirm_volunteer/{{ event.id }}" class="btn btn-sm btn-primary custom-button">
                                        Volunteer Now
                                    </a>
                                    <a href="https://www.google.com/maps/dir/?api=1&origin=Your+Current+Location&destination={{ event.address | urlencode }}"
                                        target="_blank" class="btn btn-sm btn-outline-success custom-button">
                                        <i class="bi bi-map me-1"></i>Directions
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                    {% else %}
                    <div class="text-center py-5">
                        <i class="bi bi-calendar-x display-4 text-muted mb-3"></i>
                        <p class="text-muted">No volunteer opportunities available at the moment.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Search Box -->
    <input id="search-box" type="text" placeholder="Search for a city, district, or location..." style="
        width: 300px;
        padding: 10px;
        margin: 10px auto;
        display: block;
        border: 1px solid #ddd;
        border-radius: 4px;
        " />

    <script>
        document.getElementById('reset-btn').addEventListener('mouseover', function () {
            this.style.backgroundColor = '#0056b3';
            this.style.transform = 'scale(1.05)';
        });

        document.getElementById('reset-btn').addEventListener('mouseout', function () {
            this.style.backgroundColor = '#007BFF';
            this.style.transform = 'scale(1)';
        });

        // Reset button functionality
        document.getElementById('reset-btn').addEventListener('click', () => {
            markers.forEach(marker => marker.setMap(map)); // Show all markers
            map.setCenter(mapOptions.center); // Reset map center
            map.setZoom(mapOptions.zoom); // Reset zoom
        });
    </script>

    <script>
        const eventsData = JSON.parse('{{ events_data|safe }}');
        const mapOptions = {
            center: { lat: 1.3521, lng: 103.8198 },
            zoom: 12
        };

        function initMap() {
            const map = new google.maps.Map(document.getElementById('map'), mapOptions);

            // Category icons for non-signed-up events
            const categoryIcons = {
                'Community': '{{ url_for("static", filename="images/community.png") }}',
                'Cleanup': '{{ url_for("static", filename="images/cleanup.png") }}',
                'Education': '{{ url_for("static", filename="images/education.png") }}',
                'Fundraising': '{{ url_for("static", filename="images/fundraising.png") }}',
                'Healthcare': '{{ url_for("static", filename="images/healthcare.png") }}',
            };

            // Custom marker for signed-up events
            const signedUpMarker = '{{ url_for("static", filename="images/signed-up-event.png") }}'; // Replace with your image path
            const completedMarker = '{{ url_for("static", filename="images/completed-marker.png") }}';

            const infoWindow = new google.maps.InfoWindow();

            // Add markers and store references
            const markers = eventsData.map(event => {
                const isSignedUp = event.is_signed_up;
                const isCompleted = event.is_completed; // Check if event is completed
                let markerIcon;

                if (isCompleted) {
                    markerIcon = completedMarker; // Use the completed marker for completed events
                } else {
                    markerIcon = isSignedUp
                        ? signedUpMarker
                        : (categoryIcons[event.category] || '{{ url_for("static", filename="images/default-icon.png") }}');
                }

                const marker = new google.maps.Marker({
                    position: { lat: event.latitude, lng: event.longitude },
                    map: map,
                    title: event.name,
                    icon: {
                        url: markerIcon,
                        scaledSize: new google.maps.Size(40, 40), // Resize icon to 40x40 pixels
                    },
                });

                // Attach InfoWindow content
                marker.addListener('click', () => {
                    const infoWindowContent = `
                <div style="
                    max-width: 300px;
                    padding: 10px;
                    font-family: Arial, sans-serif;
                    border-radius: 8px;
                    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                    background-color: #ffffff;
                    color: #333333;
                ">
                    <h5 style="
                        margin: 0 0 8px;
                        font-size: 18px;
                        color: #007BFF;
                    ">${event.name}</h5>
                    <p style="
                        margin: 0;
                        font-size: 14px;
                        color: #555555;
                        font-family: Arial, sans-serif;
                    ">
                        <strong>Date:</strong> ${event.date}<br>
                        <strong>Category:</strong> ${event.category}<br>
                        <strong>Address:</strong> ${event.address}
                    </p>
                    <p style="
                        margin-top: 8px;
                        font-size: 14px;
                        line-height: 1.4;
                        font-family: Arial, sans-serif;
                    ">${event.description}</p>
                    <div style="margin-top: 10px; display: flex; gap: 10px;">
                        ${isSignedUp
                            ? `<a href="https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(event.address)}" target="_blank" style="
                                    display: inline-block;
                                    padding: 8px 16px;
                                    background-color: #28A745;
                                    color: #ffffff;
                                    text-decoration: none;
                                    border-radius: 5px;
                                    font-size: 14px;
                                    text-align: center;
                                    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
                                ">Directions</a>`
                            : `
                                <a href="/confirm_volunteer/${event.id}" style="
                                    display: inline-block;
                                    padding: 8px 16px;
                                    background-color: #007BFF;
                                    color: #ffffff;
                                    text-decoration: none;
                                    border-radius: 5px;
                                    font-size: 14px;
                                    text-align: center;
                                    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
                                ">Volunteer Now!</a>
                                <a href="https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(event.address)}" target="_blank" style="
                                    display: inline-block;
                                    padding: 8px 16px;
                                    background-color: #28A745;
                                    color: #ffffff;
                                    text-decoration: none;
                                    border-radius: 5px;
                                    font-size: 14px;
                                    text-align: center;
                                    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
                                ">Directions</a>`
                        }
                    </div>
                </div>
            `;

                    infoWindow.setContent(infoWindowContent);
                    infoWindow.open(map, marker);
                });

                return marker;
            });

            // Reset functionality
            document.getElementById('reset-btn').addEventListener('click', () => {
                markers.forEach(marker => marker.setMap(map));
                map.setCenter(mapOptions.center);
                map.setZoom(mapOptions.zoom);
            });

            const searchBox = new google.maps.places.SearchBox(document.getElementById('search-box'));
            map.controls[google.maps.ControlPosition.TOP_CENTER].push(document.getElementById('search-box'));

            // Add listener for search box
            searchBox.addListener('places_changed', () => {
                const places = searchBox.getPlaces();
                if (places.length === 0) return;

                const bounds = new google.maps.LatLngBounds();
                places.forEach(place => {
                    if (!place.geometry || !place.geometry.location) return;
                    bounds.extend(place.geometry.location);
                });

                const extendFactor = 0.01;
                const center = bounds.getCenter();
                bounds.extend(new google.maps.LatLng(center.lat() + extendFactor, center.lng() + extendFactor));
                bounds.extend(new google.maps.LatLng(center.lat() - extendFactor, center.lng() - extendFactor));

                map.fitBounds(bounds);

                // Show only markers within the bounds
                let visibleMarkerFound = false;
                markers.forEach(marker => {
                    if (bounds.contains(marker.getPosition())) {
                        marker.setMap(map); // Show marker
                        visibleMarkerFound = true;
                    } else {
                        marker.setMap(null); // Hide marker
                    }
                });

                // Display a message if no visible markers remain
                if (!visibleMarkerFound) {
                    alert('No events found in this area!');
                }
            });

            // Get user's current location
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const userLat = position.coords.latitude;
                        const userLng = position.coords.longitude;

                        // Center the map on the user's current location
                        map.setCenter(new google.maps.LatLng(userLat, userLng));
                        map.setZoom(14); // Optionally set a zoom level

                        // Add a marker for the user's current location
                        const userMarker = new google.maps.Marker({
                            position: { lat: userLat, lng: userLng },
                            map: map,
                            title: 'You are here',
                            icon: {
                                url: '{{ url_for("static", filename="images/current-location.png") }}',
                                scaledSize: new google.maps.Size(40, 40), // Resize icon to 40x40 pixels
                            },
                        });

                        // Optionally, add an info window
                        userMarker.addListener('click', () => {
                            infoWindow.setContent('You are here');
                            infoWindow.open(map, userMarker);
                        });
                    },
                    () => {
                        alert('Error: The Geolocation service failed. Defaulting to Singapore.');
                    }
                );
            } else {
                alert('Error: Your browser does not support geolocation.');
            }

        }
    </script>

    <!-- Load Google Maps API -->
    <script
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCcL6Ot97Y8Gtk0-heploLjEebJOUgEJoo&libraries=places&callback=initMap"
        async defer></script>
    {% endblock %}